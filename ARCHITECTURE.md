# ðŸŽ¨ SmartAlly Visual Architecture Guide

## Complete System Flowchart

### Level 1: User Journey

```
START
  â”‚
  â”œâ”€> 1. User opens web browser
  â”‚     â””â”€> http://localhost:8501
  â”‚
  â”œâ”€> 2. Upload Documents
  â”‚     â”œâ”€> Select PDF files
  â”‚     â”œâ”€> Select HTML files
  â”‚     â””â”€> Wait for parsing (5-10 sec)
  â”‚
  â”œâ”€> 3. Configure Settings
  â”‚     â”œâ”€> Enable LLM mode (if API key available)
  â”‚     â””â”€> Or use Fallback mode (automatic)
  â”‚
  â”œâ”€> 4. Ask Question
  â”‚     â””â”€> Type: "What is the total annual operating expenses for Class A?"
  â”‚
  â”œâ”€> 5. View Results
  â”‚     â”œâ”€> See extracted value: "1.19%"
  â”‚     â”œâ”€> See location: "Annual Fund Operating Expenses"
  â”‚     â””â”€> Click page link: "ðŸ“„ Page 3"
  â”‚
  â””â”€> 6. Verify & Continue
        â”œâ”€> Click link to see source
        â””â”€> Ask more questions
```

### Level 2: Technical Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                       â”‚
â”‚                        SMARTALLY ARCHITECTURE                         â”‚
â”‚                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Layer 1: PRESENTATION (Web UI)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      Streamlit App                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚  File       â”‚  â”‚  Chat    â”‚  â”‚  Settings           â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  Uploader   â”‚  â”‚  Input   â”‚  â”‚  (LLM Toggle)       â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚        Chat History Display & Results               â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Layer 2: DOCUMENT PROCESSING                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   PyMuPDF    â”‚  â”‚  pdfplumber   â”‚  â”‚  BeautifulSoup4    â”‚       â”‚
â”‚  â”‚              â”‚  â”‚               â”‚  â”‚                    â”‚       â”‚
â”‚  â”‚  â€¢ Text      â”‚  â”‚  â€¢ Tables     â”‚  â”‚  â€¢ HTML Tags       â”‚       â”‚
â”‚  â”‚  â€¢ Pages     â”‚  â”‚  â€¢ Cells      â”‚  â”‚  â€¢ Anchors         â”‚       â”‚
â”‚  â”‚  â€¢ Metadata  â”‚  â”‚  â€¢ Structure  â”‚  â”‚  â€¢ Content         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Layer 3: INTELLIGENT EXTRACTION                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    MODE SELECTOR                              â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚         â”‚   LLM Mode     â”‚   Fallback Mode     â”‚             â”‚  â”‚
â”‚  â”‚         â”‚  (GPT-3.5)     â”‚   (Rule-Based)      â”‚             â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚                  â”‚                    â”‚                       â”‚  â”‚
â”‚  â”‚                  â†“                    â†“                       â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚         â”‚  Query Parser  â”‚   â”‚  Regex Parser   â”‚            â”‚  â”‚
â”‚  â”‚         â”‚   (AI-based)   â”‚   â”‚  (Pattern)      â”‚            â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                  â”‚                    â”‚                       â”‚  â”‚
â”‚  â”‚                  â†“                    â†“                       â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚         â”‚ Data Extractor â”‚   â”‚ Data Extractor  â”‚            â”‚  â”‚
â”‚  â”‚         â”‚   (AI-based)   â”‚   â”‚  (Regex-based)  â”‚            â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                  â”‚                    â”‚                       â”‚  â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚  â”‚                           â†“                                   â”‚  â”‚
â”‚  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚
â”‚  â”‚                  â”‚  Page Locator  â”‚                          â”‚  â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Layer 4: DATA MANAGEMENT                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   pandas     â”‚  â”‚   Session     â”‚  â”‚  Datapoint         â”‚       â”‚
â”‚  â”‚              â”‚  â”‚   Cache       â”‚  â”‚  Mappings (CSV)    â”‚       â”‚
â”‚  â”‚  â€¢ CSV ops   â”‚  â”‚               â”‚  â”‚                    â”‚       â”‚
â”‚  â”‚  â€¢ DataFramesâ”‚  â”‚  â€¢ Documents  â”‚  â”‚  â€¢ Instructions    â”‚       â”‚
â”‚  â”‚  â€¢ Filtering â”‚  â”‚  â€¢ History    â”‚  â”‚  â€¢ Output Rules    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Layer 5: EXTERNAL SERVICES                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           OpenAI GPT-3.5 Turbo API                           â”‚   â”‚
â”‚  â”‚  â€¢ Natural Language Understanding                            â”‚   â”‚
â”‚  â”‚  â€¢ Data Extraction                                           â”‚   â”‚
â”‚  â”‚  â€¢ Context Analysis                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Level 3: Detailed Data Flow

```
QUERY: "What is the total annual operating expenses for Class A?"
â”‚
â”œâ”€> STEP 1: RECEIVE QUERY
â”‚   â”‚
â”‚   â””â”€> Streamlit chat input captures user query
â”‚       â””â”€> Check if documents are loaded
â”‚
â”œâ”€> STEP 2: CHOOSE MODE
â”‚   â”‚
â”‚   â”œâ”€> If API Key Available â†’ LLM Mode
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€> Send to GPT-3.5 Turbo
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€> Parse Query
â”‚   â”‚       â”‚   â”œâ”€> Identify: "TOTAL_ANNUAL_FUND_OPERATING_EXPENSES"
â”‚   â”‚       â”‚   â””â”€> Extract: "Class A"
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€> Extract Data
â”‚   â”‚       â”‚   â”œâ”€> Search document text
â”‚   â”‚       â”‚   â”œâ”€> Search tables
â”‚   â”‚       â”‚   â”œâ”€> Find value: "1.19%"
â”‚   â”‚       â”‚   â””â”€> Capture context: "Annual Fund Operating Expenses"
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€> Locate Page
â”‚   â”‚           â”œâ”€> Match context to page content
â”‚   â”‚           â””â”€> Find: Page 3
â”‚   â”‚
â”‚   â””â”€> If No API Key â†’ Fallback Mode
â”‚       â”‚
â”‚       â””â”€> Use Regex Patterns
â”‚           â”‚
â”‚           â”œâ”€> Parse Query
â”‚           â”‚   â”œâ”€> Match keywords
â”‚           â”‚   â””â”€> Extract class from pattern
â”‚           â”‚
â”‚           â”œâ”€> Extract Data
â”‚           â”‚   â”œâ”€> Apply regex to text
â”‚           â”‚   â”œâ”€> Search tables by position
â”‚           â”‚   â””â”€> Find value: "1.19%"
â”‚           â”‚
â”‚           â””â”€> Locate Page (approximate)
â”‚               â””â”€> Search for section keywords
â”‚
â”œâ”€> STEP 3: FORMAT RESPONSE
â”‚   â”‚
â”‚   â”œâ”€> Apply output rule: "percentage"
â”‚   â”‚   â””â”€> Format as: "1.19%"
â”‚   â”‚
â”‚   â”œâ”€> Create location description
â”‚   â”‚   â””â”€> "Annual Fund Operating Expenses"
â”‚   â”‚
â”‚   â””â”€> Generate hyperlink
â”‚       â””â”€> "ðŸ“„ Page 3"
â”‚
â””â”€> STEP 4: DISPLAY RESULT
    â”‚
    â””â”€> "The total annual fund operating expenses for Class A is 1.19%
         (found in Annual Fund Operating Expenses - ðŸ“„ Page 3)"
```

## Processing Pipeline Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                       DOCUMENT UPLOAD PIPELINE                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€> PDF File Uploaded
        â”‚   â”‚
        â”‚   â”œâ”€> Step 1: PyMuPDF Text Extraction
        â”‚   â”‚   â””â”€> Extract text from each page
        â”‚   â”‚       â””â”€> Store in Dict[page_num -> text]
        â”‚   â”‚
        â”‚   â”œâ”€> Step 2: pdfplumber Table Extraction
        â”‚   â”‚   â””â”€> Detect tables in each page
        â”‚   â”‚       â””â”€> Store in Dict[page_num -> List[tables]]
        â”‚   â”‚
        â”‚   â””â”€> Step 3: Cache Results
        â”‚       â””â”€> Save to session_state['parsed_docs']
        â”‚
        â””â”€> HTML File Uploaded
            â”‚
            â”œâ”€> Step 1: BeautifulSoup Parsing
            â”‚   â””â”€> Parse HTML structure
            â”‚       â””â”€> Extract text and preserve anchors
            â”‚
            â””â”€> Step 2: Cache Results
                â””â”€> Save to session_state['parsed_docs']

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                       QUERY PROCESSING PIPELINE                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€> User Query Received
        â”‚   â””â”€> "What is the total annual operating expenses for Class A?"
        â”‚
        â”œâ”€> Load Cached Documents
        â”‚   â”œâ”€> Get text from all pages
        â”‚   â””â”€> Get all extracted tables
        â”‚
        â”œâ”€> Mode Selection
        â”‚   â”‚
        â”‚   â”œâ”€> LLM Mode (if API key configured)
        â”‚   â”‚   â”‚
        â”‚   â”‚   â”œâ”€> Call: parse_user_prompt_with_llm()
        â”‚   â”‚   â”‚   â”œâ”€> Input: User query + datapoint list
        â”‚   â”‚   â”‚   â”œâ”€> Output: Datapoint name + Class
        â”‚   â”‚   â”‚   â””â”€> Uses: GPT-3.5 with JSON response
        â”‚   â”‚   â”‚
        â”‚   â”‚   â””â”€> Call: extract_datapoint_with_llm()
        â”‚   â”‚       â”œâ”€> Input: Text + Tables + Datapoint + Class
        â”‚   â”‚       â”œâ”€> Output: Value + Location + Page
        â”‚   â”‚       â””â”€> Uses: GPT-3.5 with context analysis
        â”‚   â”‚
        â”‚   â””â”€> Fallback Mode (automatic without API key)
        â”‚       â”‚
        â”‚       â”œâ”€> Call: parse_user_prompt_fallback()
        â”‚       â”‚   â”œâ”€> Input: User query
        â”‚       â”‚   â”œâ”€> Output: Datapoint name + Class
        â”‚       â”‚   â””â”€> Uses: Regex pattern matching
        â”‚       â”‚
        â”‚       â””â”€> Call: extract_datapoint()
        â”‚           â”œâ”€> Input: Text + Tables + Datapoint + Class
        â”‚           â”œâ”€> Output: Value + Location
        â”‚           â””â”€> Uses: Regex + table lookup
        â”‚
        â”œâ”€> Format Response
        â”‚   â”œâ”€> Apply output rule (currency, percentage, text)
        â”‚   â”œâ”€> Generate hyperlink with page number
        â”‚   â””â”€> Create user-friendly message
        â”‚
        â””â”€> Display in Chat
            â””â”€> Add to message history
            â””â”€> Render in Streamlit interface
```

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                    COMPONENT INTERACTIONS                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     User     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ Uploads files & asks questions
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Streamlit   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     App      â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
           â”‚                       â”‚
           â”‚ Parse documents       â”‚ Load config
           â†“                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Document    â”‚        â”‚  datapoint_     â”‚
    â”‚  Parsers     â”‚        â”‚  mapping.csv    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Extracted text & tables
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Session     â”‚
    â”‚  Cache       â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Cached documents
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Extraction Engine   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€> LLM Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                          â”‚
           â”‚                          â†“
           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                   â”‚  OpenAI API  â”‚
           â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚
           â”‚                          â”‚ AI response
           â”‚                          â†“
           â””â”€â”€> Fallback Mode â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   Results    â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ Formatted results
                                               â†“
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   Display    â”‚
                                        â”‚   to User    â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Management Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                     SESSION STATE MANAGEMENT                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Streamlit Session State:
â”‚
â”œâ”€> session_state['messages']
â”‚   â””â”€> List of chat messages
â”‚       â”œâ”€> {"role": "user", "content": "What is..."}
â”‚       â””â”€> {"role": "assistant", "content": "The value is..."}
â”‚
â”œâ”€> session_state['parsed_docs']
â”‚   â””â”€> Dict of parsed documents
â”‚       â”œâ”€> "document1.pdf"
â”‚       â”‚   â”œâ”€> 'pages': {1: "text...", 2: "text..."}
â”‚       â”‚   â”œâ”€> 'tables': {1: [...], 2: [...]}
â”‚       â”‚   â””â”€> 'type': 'pdf'
â”‚       â””â”€> "document2.html"
â”‚           â”œâ”€> 'pages': {1: "text..."}
â”‚           â””â”€> 'type': 'html'
â”‚
â”œâ”€> session_state['use_llm']
â”‚   â””â”€> Boolean flag for LLM mode
â”‚       â”œâ”€> True: Use GPT-3.5 Turbo
â”‚       â””â”€> False: Use regex fallback
â”‚
â””â”€> Environment Variables (.env file)
    â”œâ”€> OPENAI_API_KEY
    â””â”€> OPENAI_MODEL
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                        ERROR HANDLING FLOW                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Action
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try: Process Request               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€> Success
    â”‚   â””â”€> Return results to user
    â”‚
    â””â”€> Error Detected
        â”‚
        â”œâ”€> API Key Missing
        â”‚   â””â”€> Automatically switch to Fallback Mode
        â”‚       â””â”€> Continue processing
        â”‚
        â”œâ”€> API Request Failed
        â”‚   â”œâ”€> Show warning to user
        â”‚   â””â”€> Fallback to rule-based extraction
        â”‚       â””â”€> Return approximate results
        â”‚
        â”œâ”€> Document Parsing Error
        â”‚   â”œâ”€> Show error message
        â”‚   â””â”€> Suggest: Check file format
        â”‚
        â”œâ”€> Value Not Found
        â”‚   â”œâ”€> Return: "Value not found" or "0"
        â”‚   â””â”€> Suggest: Try different query
        â”‚
        â””â”€> Unknown Error
            â”œâ”€> Log error details
            â”œâ”€> Show user-friendly message
            â””â”€> Graceful degradation
```

## Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                       DEPLOYMENT OPTIONS                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTION 1: Local Development
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Developer Machine                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Python 3.8+                 â”‚  â”‚
â”‚  â”‚  â”œâ”€> Install dependencies    â”‚  â”‚
â”‚  â”‚  â”œâ”€> Configure .env          â”‚  â”‚
â”‚  â”‚  â””â”€> Run: streamlit run      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Access: http://localhost:8501     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTION 2: Cloud Deployment (Streamlit Cloud)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Streamlit Cloud                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GitHub Repository           â”‚  â”‚
â”‚  â”‚  â”œâ”€> Auto-deploy on push     â”‚  â”‚
â”‚  â”‚  â”œâ”€> Secrets management      â”‚  â”‚
â”‚  â”‚  â””â”€> Public/Private access   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Access: https://app.streamlit.io  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTION 3: Docker Container
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Container                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Dockerfile                  â”‚  â”‚
â”‚  â”‚  â”œâ”€> Python base image       â”‚  â”‚
â”‚  â”‚  â”œâ”€> Install requirements    â”‚  â”‚
â”‚  â”‚  â”œâ”€> Copy application files  â”‚  â”‚
â”‚  â”‚  â””â”€> Expose port 8501        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Run: docker run -p 8501:8501     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                       SECURITY LAYERS                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: API Key Security
â”œâ”€> Stored in .env file (git ignored)
â”œâ”€> Never committed to repository
â”œâ”€> Environment variable support
â””â”€> Rotation capability

Layer 2: Data Privacy
â”œâ”€> Local document processing
â”œâ”€> No data sent to external servers (except OpenAI API)
â”œâ”€> Session-based storage (not persistent)
â””â”€> Clear cache on session end

Layer 3: API Communication
â”œâ”€> HTTPS encryption for OpenAI API calls
â”œâ”€> Rate limiting support
â”œâ”€> Usage tracking available
â””â”€> Error handling without data leakage

Layer 4: Input Validation
â”œâ”€> File type validation
â”œâ”€> File size limits
â”œâ”€> Query sanitization
â””â”€> Output formatting validation
```

## Performance Optimization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚                    PERFORMANCE OPTIMIZATIONS                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Document Upload
â”‚
â”œâ”€> Optimization 1: Caching
â”‚   â””â”€> Parse once, reuse multiple times
â”‚       â””â”€> Stored in session_state
â”‚
â”œâ”€> Optimization 2: Incremental Processing
â”‚   â””â”€> Parse only new/changed documents
â”‚       â””â”€> Skip already cached documents
â”‚
â””â”€> Optimization 3: Lazy Loading
    â””â”€> Parse on demand
        â””â”€> Background processing

Query Processing
â”‚
â”œâ”€> Optimization 1: Quick Mode Check
â”‚   â””â”€> Check API key availability first
â”‚       â””â”€> Skip LLM overhead if unavailable
â”‚
â”œâ”€> Optimization 2: Context Limiting
â”‚   â””â”€> Send only first 8000 chars to LLM
â”‚       â””â”€> Reduce token usage and cost
â”‚
â””â”€> Optimization 3: Table Limiting
    â””â”€> Send only first 5 tables to LLM
        â””â”€> Reduce processing time

Response Generation
â”‚
â””â”€> Optimization 1: Page Caching
    â””â”€> Cache page lookups
        â””â”€> Faster subsequent queries
```

---

## Quick Reference

### Key Files
- `smartally.py` - Main application (860 lines)
- `datapoint_mapping.csv` - Configuration
- `.env` - API key (create this, not in git)
- `requirements.txt` - Dependencies

### Key Functions
- `main()` - Streamlit app entry point
- `parse_pdf()` - PDF text extraction
- `parse_user_prompt_with_llm()` - Query parsing (AI)
- `extract_datapoint_with_llm()` - Data extraction (AI)
- `chatbot_response()` - Main coordinator

### Key URLs
- Local: http://localhost:8501
- OpenAI: https://platform.openai.com/api-keys
- GitHub: https://github.com/Tendool/Yitro-Smartally

### Key Commands
```bash
# Install
pip install -r requirements.txt

# Configure
cp .env.example .env
nano .env

# Run
streamlit run smartally.py
```
